<section class="user-management" dir="rtl">
  <div class="user-management__header">
    <h1 class="user-management__title">ניהול משתמשים</h1>
    @if (isAdmin && !isLoading && !errorMessage) {
      <div
        class="user-management__success"
        >
        נטענו בהצלחה {{ users.length }} משתמשים.
      </div>
    }
    @if (isAdmin && !isLoading && errorMessage) {
      <div
        class="user-management__error"
        >
        {{ errorMessage }}
      </div>
    }
  </div>

  @if (!isAdmin) {
    <div class="user-management__restricted">
      אין לך הרשאה לצפות בעמוד זה.
    </div>
  }

  @if (isAdmin) {
    <div class="user-management__content">
      @if (isLoading) {
        <div class="user-management__status">טוען משתמשים...</div>
      }
      @if (!isLoading && !errorMessage && users.length === 0) {
        <div class="user-management__empty">
          אין משתמשים להצגה.
        </div>
      }
      @if (!isLoading && !errorMessage && users.length > 0) {
        <div class="user-management__table-wrapper">
          <table class="user-management__table">
            <thead>
              <tr>
                <th></th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('id')">
                    מזהה
                    @if (sortField === 'id') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('username')">
                    שם משתמש
                    @if (sortField === 'username') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('role')">
                    תפקיד
                    @if (sortField === 'role') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('currentRank')">
                    דרגה
                    @if (sortField === 'currentRank') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('firstName')">
                    שם פרטי
                    @if (sortField === 'firstName') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('lastName')">
                    שם משפחה
                    @if (sortField === 'lastName') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>אימייל</th>
                <th>טלפון</th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('dateOfBirth')">
                    תאריך לידה
                    @if (sortField === 'dateOfBirth') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('level')">
                    רמה
                    @if (sortField === 'level') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>תיאור</th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('joinDate')">
                    תאריך הצטרפות
                    @if (sortField === 'joinDate') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('isActive')">
                    פעיל
                    @if (sortField === 'isActive') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('isEmailVerified')">
                    אימות אימייל
                    @if (sortField === 'isEmailVerified') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
                <th>
                  <button type="button" class="user-management__sort-btn" (click)="setSort('lastLoginAt')">
                    התחברות אחרונה
                    @if (sortField === 'lastLoginAt') {
                      <span class="user-management__sort-indicator">
                        {{ sortDirection === 'asc' ? '▲' : '▼' }}
                      </span>
                    }
                  </button>
                </th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track trackByUserId($index, user)) {
                <tr>
                  <td>
                    @if (getProfileImageSrc(user.profileImageUrl)) {
                      <button
                        type="button"
                        class="user-management__avatar-btn"
                        (click)="openImagePopup(getProfileImageSrcLarge(user.profileImageUrl) || getProfileImageSrc(user.profileImageUrl)!)"
                        [attr.aria-label]="'תמונת פרופיל של ' + (user.displayName || user.username || '')"
                        >
                        <img
                          [src]="getProfileImageSrc(user.profileImageUrl)"
                          [alt]="user.displayName || user.username || 'תמונת פרופיל'"
                          class="user-management__avatar"
                          loading="lazy"
                          />
                        </button>
                      }
                      @if (!getProfileImageSrc(user.profileImageUrl)) {
                        <span>—</span>
                      }
                    </td>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username || '—' }}</td>
                    <td>{{ user.role || '—' }}</td>
                    <td>{{ getRankName(user.currentRankId) }}</td>
                    <td>{{ user.firstName || '—' }}</td>
                    <td>{{ user.lastName || '—' }}</td>
                    <td>{{ user.email || '—' }}</td>
                    <td>{{ user.phone || '—' }}</td>
                    <td>{{ user.dateOfBirth || '—' }}</td>
                    <td>{{ user.level || '—' }}</td>
                    <td>{{ user.bio || '—' }}</td>
                    <td>{{ user.joinDate || '—' }}</td>
                    <td>{{ user.isActive === true ? 'כן' : (user.isActive === false ? 'לא' : '—') }}</td>
                    <td>{{ user.isEmailVerified === true ? 'כן' : (user.isEmailVerified === false ? 'לא' : '—') }}</td>
                    <td>{{ formatLastLogin(user.lastLoginAt) }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }

    <!-- Profile image popup -->
    @if (popupImageSrc) {
      <div
        class="user-management__popup-overlay"
        (click)="closeImagePopup()"
        role="button"
        tabindex="0"
        aria-label="סגור תמונת פרופיל"
        >
        <img
          class="user-management__popup-image"
          [src]="popupImageSrc"
          alt="תמונת פרופיל מוגדלת"
          (click)="$event.stopPropagation()"
          />
        </div>
      }
    </section>
