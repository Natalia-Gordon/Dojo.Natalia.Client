<!-- Hero Start -->
<app-user-details-hero></app-user-details-hero>
<!-- Hero End -->

<!-- Blog Start -->
<div class="container-fluid p-5">
  <div class="row g-5">
    <!-- Sidebar Start - Right Side -->
    <div class="col-lg-4 order-lg-2" dir="rtl">
      <!-- User Info Card -->
      @if (user) {
        <div class="user-info-card">
          <!-- Avatar Section -->
          <div class="user-info-card__header">
            <div class="user-avatar-large">
              <span class="avatar-initial-large">{{ getUserInitials() }}</span>
            </div>
            <h4 class="user-info-card__name">
              {{ getDisplayName() }}
            </h4>
            <p class="user-info-card__email">
              <i class="bi bi-envelope me-1"></i>
              {{ user.email }}
            </p>
            @if (user.firstName || user.lastName) {
              <p class="user-info-card__full-name">
                <i class="bi bi-person me-1"></i>
                {{ user.firstName }} {{ user.lastName }}
              </p>
            }
          </div>
          <!-- Info Items -->
          <div class="user-info-card__body">
            <!-- Last Login -->
            @if (user.lastLoginAt) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-clock-history"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">התחברות אחרונה</div>
                  <div class="info-item__value">{{ formatLastLogin(user.lastLoginAt) }}</div>
                </div>
              </div>
            }
            <!-- Join Date or Created At -->
            @if (user.joinDate || user.createdAt) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-calendar-date"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">תאריך הצטרפות</div>
                  <div class="info-item__value">{{ formatDate(user.joinDate || user.createdAt) }}</div>
                </div>
              </div>
            }
            <!-- Role -->
            <div class="info-item">
              <div class="info-item__icon">
                <i class="bi bi-person-badge"></i>
              </div>
              <div class="info-item__content">
                <div class="info-item__label">תפקיד</div>
                <div class="info-item__value">
                  @if (user.role) {
                    <span class="badge badge-role">{{ user.role }}</span>
                  }
                  @if (!user.role) {
                    <span class="text-muted small">לא הוגדר</span>
                  }
                </div>
              </div>
            </div>
            <!-- Level -->
            @if (user.level) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-star-fill"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">רמה</div>
                  <div class="info-item__value">
                    <span class="badge" [ngClass]="getLevelColor(user.level)">
                      {{ user.level }}
                    </span>
                  </div>
                </div>
              </div>
            }
            <!-- Status -->
            @if (user.isActive !== undefined) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-circle-fill" [ngClass]="user.isActive ? 'text-success' : 'text-secondary'"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">סטטוס</div>
                  <div class="info-item__value">
                    <span class="badge" [ngClass]="user.isActive ? 'bg-success' : 'bg-secondary'">
                      {{ user.isActive ? 'פעיל' : 'לא פעיל' }}
                    </span>
                  </div>
                </div>
              </div>
            }
            <!-- Email Verified -->
            @if (user.isEmailVerified !== undefined) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi" [class.bi-check-circle-fill]="user.isEmailVerified" [class.bi-x-circle-fill]="!user.isEmailVerified" [ngClass]="user.isEmailVerified ? 'text-success' : 'text-warning'"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">אימות דוא"ל</div>
                  <div class="info-item__value">
                    <span class="badge" [ngClass]="user.isEmailVerified ? 'bg-success' : 'bg-warning'">
                      {{ user.isEmailVerified ? 'מאומת' : 'לא מאומת' }}
                    </span>
                  </div>
                </div>
              </div>
            }
            <!-- Created At -->
            @if (user.createdAt) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-calendar-plus"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">תאריך יצירה</div>
                  <div class="info-item__value">{{ formatDate(user.createdAt) }}</div>
                </div>
              </div>
            }
            <!-- Updated At -->
            @if (user.updatedAt) {
              <div class="info-item">
                <div class="info-item__icon">
                  <i class="bi bi-calendar-check"></i>
                </div>
                <div class="info-item__content">
                  <div class="info-item__label">עודכן לאחרונה</div>
                  <div class="info-item__value">{{ formatDate(user.updatedAt) }}</div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
    <!-- Sidebar End -->

    <!-- Main Content - Left Side -->
    <div class="col-lg-8 order-lg-1" dir="rtl">
      <!-- User Details Start -->
      <div class="mb-5">

        <!-- Error Message -->
        @if (errorMessage) {
          <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <strong>שגיאה:</strong> {{ errorMessage }}
            @if (isUnauthorized) {
              <div class="mt-3">
                <button type="button" class="btn btn-danger" (click)="openLoginModal()">
                  <i class="bi bi-box-arrow-in-right me-2"></i>
                  התחברות
                </button>
              </div>
            }
            <button type="button" class="btn-close btn-close-white" (click)="errorMessage = null; isUnauthorized = false" aria-label="Close"></button>
          </div>
        }

        <!-- Success Message -->
        @if (successMessage) {
          <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <strong>הצלחה:</strong> {{ successMessage }}
            <button type="button" class="btn-close" (click)="successMessage = null" aria-label="Close"></button>
          </div>
        }

        <!-- Loading State -->
        @if (isLoading && !user) {
          <div class="text-center py-5">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">טוען...</span>
            </div>
          </div>
        }

        <!-- User Details Form -->
        @if (user && !isLoading) {
          <div>
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3 class="fw-bold mb-0">{{ isEditMode ? 'עריכת פרטים' : 'פרטי משתמש' }}</h3>
              <button
                type="button"
                class="btn btn-outline-danger"
                (click)="toggleEditMode()">
                <i class="bi" [class.bi-pencil]="!isEditMode" [class.bi-x]="isEditMode"></i>
                &nbsp;
                {{ isEditMode ? 'ביטול' : 'עריכה' }}
              </button>
            </div>
            <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
              <div class="bg-light rounded p-4 mb-4">
                <h5 class="fw-bold mb-3 text-secondary">
                  <i class="bi bi-person-circle me-2"></i>
                  פרטים אישיים
                </h5>
                <div class="row g-3">
                  <!-- Username -->
                  <div class="col-12 col-md-6">
                    <label class="form-label text-secondary fw-bold">
                      שם משתמש
                      <span class="text-muted small ms-2">
                        <i class="bi bi-info-circle" title="לא ניתן לשנות שם משתמש לאחר יצירת החשבון"></i>
                      </span>
                    </label>
                    <input
                      type="text"
                      class="form-control bg-white border-0 shadow-sm"
                      formControlName="username"
                      [readonly]="true"
                      style="height: 45px; cursor: not-allowed; opacity: 0.7;">
                      <small class="text-muted d-block mt-1">
                        <i class="bi bi-lock me-1"></i>
                        שם משתמש לא ניתן לשינוי
                      </small>
                      @if (getFieldError('username')) {
                        <div class="text-danger small mt-1">
                          {{ getFieldError('username') }}
                        </div>
                      }
                    </div>
                    <!-- Email -->
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary fw-bold">כתובת דוא"ל <span class="text-danger">*</span></label>
                      <input
                        type="email"
                        class="form-control bg-white border-0 shadow-sm"
                        formControlName="email"
                        [readonly]="!isEditMode"
                        style="height: 45px;">
                        @if (getFieldError('email')) {
                          <div class="text-danger small mt-1">
                            {{ getFieldError('email') }}
                          </div>
                        }
                      </div>
                      <!-- First Name -->
                      <div class="col-12 col-md-6">
                        <label class="form-label text-secondary fw-bold">שם פרטי</label>
                        <input
                          type="text"
                          class="form-control bg-white border-0 shadow-sm"
                          formControlName="firstName"
                          [readonly]="!isEditMode"
                          style="height: 45px;">
                        </div>
                        <!-- Last Name -->
                        <div class="col-12 col-md-6">
                          <label class="form-label text-secondary fw-bold">שם משפחה</label>
                          <input
                            type="text"
                            class="form-control bg-white border-0 shadow-sm"
                            formControlName="lastName"
                            [readonly]="!isEditMode"
                            style="height: 45px;">
                          </div>
                          <!-- Display Name -->
                          <div class="col-12 col-md-6">
                            <label class="form-label text-secondary fw-bold">שם תצוגה</label>
                            <input
                              type="text"
                              class="form-control bg-white border-0 shadow-sm"
                              formControlName="displayName"
                              [readonly]="!isEditMode"
                              style="height: 45px;">
                            </div>
                            <!-- Phone Number -->
                            <div class="col-12 col-md-6">
                              <label class="form-label text-secondary fw-bold">מספר טלפון</label>
                              <input
                                type="tel"
                                class="form-control bg-white border-0 shadow-sm"
                                formControlName="phone"
                                [readonly]="!isEditMode"
                                style="height: 45px;">
                              </div>
                              <!-- Date of Birth -->
                              <div class="col-12 col-md-6">
                                <label class="form-label text-secondary fw-bold">תאריך לידה</label>
                                @if (isEditMode) {
                                  <input
                                    type="date"
                                    class="form-control bg-white border-0 shadow-sm"
                                    formControlName="dateOfBirth"
                                    style="height: 45px;">
                                }
                                @if (!isEditMode && user) {
                                  <div class="form-control bg-white border-0 shadow-sm d-flex align-items-center" style="height: 45px; min-height: 45px;">
                                    {{ formatDate(user.dateOfBirth) || 'לא הוגדר' }}
                                  </div>
                                }
                              </div>
                              <!-- Bio -->
                              <div class="col-12">
                                <label class="form-label text-secondary fw-bold">אודות</label>
                                <textarea
                                  class="form-control bg-white border-0 shadow-sm"
                                  formControlName="bio"
                                  [readonly]="!isEditMode"
                                  rows="4"
                                placeholder="ספר על עצמך..."></textarea>
                              </div>
                            </div>
                          </div>
                          <!-- Password Section (only in edit mode) -->
                          @if (isEditMode) {
                            <div class="bg-light rounded p-4 mb-4">
                              <h5 class="fw-bold mb-3 text-secondary">
                                <i class="bi bi-lock me-2"></i>
                                שינוי סיסמה
                              </h5>
                              <p class="text-secondary small mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                השאר את השדות הבאים ריקים אם אינך רוצה לשנות את הסיסמה
                              </p>
                              <div class="row g-3">
                                <div class="col-12 col-md-6">
                                  <label class="form-label text-secondary fw-bold">סיסמה חדשה</label>
                                  <input
                                    type="password"
                                    class="form-control bg-white border-0 shadow-sm"
                                    formControlName="password"
                                    placeholder="הזן סיסמה חדשה"
                                    style="height: 45px;">
                                    @if (getFieldError('password')) {
                                      <div class="text-danger small mt-1">
                                        {{ getFieldError('password') }}
                                      </div>
                                    }
                                  </div>
                                  <div class="col-12 col-md-6">
                                    <label class="form-label text-secondary fw-bold">אישור סיסמה</label>
                                    <input
                                      type="password"
                                      class="form-control bg-white border-0 shadow-sm"
                                      formControlName="confirmPassword"
                                      placeholder="הזן שוב את הסיסמה"
                                      style="height: 45px;">
                                      @if (getFieldError('confirmPassword')) {
                                        <div class="text-danger small mt-1">
                                          {{ getFieldError('confirmPassword') }}
                                        </div>
                                      }
                                    </div>
                                  </div>
                                </div>
                              }
                              <!-- Payment methods (instructors only) -->
                              @if (user && isInstructor()) {
                                <div class="bg-light rounded p-4 mb-4">
                                  <h5 class="fw-bold mb-3 text-secondary">
                                    <i class="bi bi-credit-card me-2"></i>
                                    שיטות תשלום שלי
                                  </h5>
                                  @if (paymentMethodError) {
                                    <div class="alert alert-danger py-2 mb-3">{{ paymentMethodError }}</div>
                                  }
                                  @if (isLoadingPaymentMethods) {
                                    <p class="text-muted small"><span class="spinner-border spinner-border-sm me-2"></span>טוען שיטות תשלום...</p>
                                  }
                                  @if (!isLoadingPaymentMethods) {
                                    <ul class="list-group list-group-flush mb-3">
                                      @for (pm of paymentMethods; track pm.id) {
                                        <li class="list-group-item d-flex justify-content-between align-items-center bg-white rounded mb-2">
                                          <div>
                                            <span class="badge me-2" [ngClass]="pm.paymentType === 'bit' ? 'bg-info' : 'bg-secondary'">
                                              {{ pm.paymentType === 'bit' ? 'ביט' : 'העברה בנקאית' }}
                                            </span>
                                            @if (pm.isDefault) {
                                              <span class="badge bg-danger small">ברירת מחדל</span>
                                            }
                                            <span class="ms-2">{{ getPaymentMethodDisplayText(pm) }}</span>
                                          </div>
                                          <div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-1" (click)="openEditPaymentMethod(pm)" title="עריכה">
                                              <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" (click)="deletePaymentMethod(pm.id)" title="מחיקה">
                                              <i class="bi bi-trash"></i>
                                            </button>
                                          </div>
                                        </li>
                                      }
                                    </ul>
                                    @if (paymentMethods.length === 0 && !showPaymentMethodForm) {
                                      <p class="text-muted small mb-3">אין שיטות תשלום. הוסף ביט או העברה בנקאית כדי שמשתתפים יוכלו לשלם.</p>
                                    }
                                    @if (!showPaymentMethodForm) {
                                      <button type="button" class="btn btn-outline-danger btn-sm" (click)="openAddPaymentMethod()">
                                        <i class="bi bi-plus-lg me-1"></i>
                                        הוסף שיטת תשלום
                                      </button>
                                    }
                                    @if (showPaymentMethodForm) {
                                      <div class="border rounded p-3 bg-white mb-3">
                                        <h6 class="mb-3">{{ paymentMethodFormTitle }}</h6>
                                        <form (ngSubmit)="savePaymentMethod()" [formGroup]="paymentMethodForm">
                                          <div class="row g-2 mb-2">
                                            <div class="col-12 col-md-6">
                                              <label class="form-label small fw-bold">סוג</label>
                                              <select class="form-control form-control-sm" formControlName="paymentType">
                                                <option value="bank_transfer">העברה בנקאית</option>
                                                <option value="bit">ביט (Bit)</option>
                                              </select>
                                            </div>
                                            <div class="col-12 col-md-6 d-flex align-items-end">
                                              <div class="form-check">
                                                <input type="checkbox" class="form-check-input" formControlName="isDefault" id="pmDefault">
                                                <label class="form-check-label small" for="pmDefault">ברירת מחדל</label>
                                              </div>
                                            </div>
                                          </div>
                                          @if (paymentTypeFormValue === 'bit') {
                                            <div class="mb-2">
                                              <label class="form-label small fw-bold">מספר טלפון (ביט) <span class="text-danger">*</span></label>
                                              <input type="tel" class="form-control form-control-sm" formControlName="phoneNumber" placeholder="למשל 050-1234567">
                                            </div>
                                          }
                                          @if (paymentTypeFormValue === 'bank_transfer') {
                                            <div class="row g-2 small">
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">שם הבנק</label><input type="text" class="form-control form-control-sm" formControlName="bankName"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">מספר בנק</label><input type="text" class="form-control form-control-sm" formControlName="bankNumber"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">סניף / שם סניף</label><input type="text" class="form-control form-control-sm" formControlName="branchName"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">מספר סניף</label><input type="text" class="form-control form-control-sm" formControlName="branchNumber"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">מספר חשבון</label><input type="text" class="form-control form-control-sm" formControlName="accountNumber"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">שם בעל החשבון</label><input type="text" class="form-control form-control-sm" formControlName="accountHolderName"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">IBAN</label><input type="text" class="form-control form-control-sm" formControlName="iban"></div>
                                              <div class="col-12 col-md-6"><label class="form-label fw-bold">SWIFT/BIC</label><input type="text" class="form-control form-control-sm" formControlName="swiftBic"></div>
                                              <div class="col-12"><label class="form-label fw-bold">כתובת הבנק</label><input type="text" class="form-control form-control-sm" formControlName="bankAddress"></div>
                                            </div>
                                          }
                                          <div class="mt-3 d-flex gap-2">
                                            <button type="submit" class="btn btn-danger btn-sm" [disabled]="isSavingPaymentMethod">
                                              @if (isSavingPaymentMethod) {
                                                <span class="spinner-border spinner-border-sm me-1"></span>
                                              }
                                              שמור
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="closePaymentMethodForm()">ביטול</button>
                                          </div>
                                        </form>
                                      </div>
                                    }
                                  }
                                </div>
                              }
                              <!-- Submit Button -->
                              @if (isEditMode) {
                                <div class="d-flex justify-content-end">
                                  <button
                                    type="submit"
                                    class="btn btn-danger px-5 py-3"
                                    [disabled]="isLoading || profileForm.invalid">
                                    @if (isLoading) {
                                      <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    @if (!isLoading) {
                                      <i class="bi bi-check-lg me-2"></i>
                                    }
                                    שמור שינויים
                                  </button>
                                </div>
                              }
                            </form>
                          </div>
                        }
                      </div>
                      <!-- User Details End -->
                    </div>
                    <!-- Main Content End -->
                  </div>
                </div>
                <!-- Blog End -->
